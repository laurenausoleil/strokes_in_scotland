----
Libraries
----

```{r}
library(tidyverse)
library(janitor)
library(stringr)
library(readxl)
```

----
Load datasets
----

Discharges By Health Board
```{r}
discharges_by_healthboard <- read_csv("../../data/raw_data/stroke_activitybyhbr.csv") %>% 
# Remove Qualifiers
  select(-contains("QF")) %>% 
# Clean Names
  clean_names() %>% 
# Make Readable
  rename(healthboard_area = hbr) %>% 
# Remove Unused Variable
  select(-admission_type)
```

Mortality By Health Board
```{r}
mortality_by_healthboard <- read_csv("../../data/raw_data/stroke_mortalitybyhbr.csv") %>% 
# Remove Qualifer
  select(-contains("QF")) %>% 
# Clean names
  clean_names() %>% 
# Make Readable
  rename(healthboard_area = hbr)
```

Hospital Stays By Health Board
```{r}
hospitalstays_by_healthboard <- read_xlsx("../../data/raw_data/Diagnosis-by-Health-Board-of-Residence-Sep19.xlsx", sheet = 4)
```

Health Board Codes
```{r}
healthboard_codes <- read_csv("../../data/raw_data/healthboard_codes.csv") %>%
# Clean Names
  clean_names() %>% 
# Convert healthboard area names to match hospitalstays_by_healthboard
  mutate(hb_name =
           str_replace_all(hb_name, " and ", " & ")) %>% 
# Select Relevant Variables
  select(hb_name, hb) %>% 
# Make Readable
  rename("healthboard_area" = "hb")
```

----
Wrangling
----

Discharges By Health Board
```{r}
# Remove "/[0-9][0-9]" from discharges by hb
discharges_by_healthboard <- discharges_by_healthboard %>%
  mutate(approx_year = as.numeric(str_sub(financial_year, start = 1, end = -4)))
```

Hospital Stays by Health Board

 - Filter to only relevant diagnoses, allow missing capital letters
```{r}
hospitalstays_by_healthboard <- hospitalstays_by_healthboard %>%  
  filter(str_detect(lookup, 
      "[Cc]erebrovascular [Dd]isease|[Ss]troke|[Ss]ubarachnoid [Hh]aemorrhage|TIAs|[Tt]ransient [Ii]schemic [Aa]ttack"))
```

 - Seperate lookup column into financial_year, healthboard_area_named, sex, age_group, diagnosis
```{r}
hospitalstays_by_healthboard <- hospitalstays_by_healthboard %>% 
# financial_year
  separate(col = lookup, into = c("financial_year", "lookup_remain1"), sep = 7, remove = FALSE) %>% 
# diagnosis
  separate(col = lookup_remain1, into = c("lookup_remain2", "diagnosis"), sep = " -") %>%
# sex
  mutate(sex = case_when(
    str_detect(lookup, "Male") ~ "Male",
    str_detect(lookup, "Female") ~ "Female",
    str_detect(lookup, "Both Sexes") ~ "All"
  )) %>%
# healthboard_area and age_group
  separate(col = lookup_remain2, into = c("healthboard_area_named", "age_group"), sep = "Male|Female|Both Sexes")  %>% 
# remove original lookup variable from cleaned data
  select(-c(lookup, discharge_finyr, hbresname, age_grp, diag))
```

 - Mutate age_groups to match discharges and mortality
```{r}
hospitalstays_by_healthboard <- hospitalstays_by_healthboard %>% 
  mutate(age_group =
    case_when(
      age_group  == "00-14 " ~ "0-44 years",
      age_group  == "15-24 " ~ "0-44 years",
      age_group  == "25-34 " ~ "0-44 years",
      age_group  == "35-44 " ~ "0-44 years",
      age_group  == "45-54 " ~ "45-64 years",
      age_group  == "55-64 " ~ "45-64 years",
      age_group  == "65-74 " ~ "65-74 years",
      age_group  == "65+ " ~ "65-74 years",
      age_group  == "75+ " ~ "75plus years",
      age_group  == "75-84 " ~ "75plus years",
      age_group  == "85+ " ~ "75plus years",
      age_group  == "All ages " ~ "All"
    )
  )
```

 - Mutate diagnosis to match discharges and mortality
```{r}
hospitalstays_by_healthboard <- hospitalstays_by_healthboard %>% 
  mutate(diagnosis = if_else(
    diagnosis == "Cerebrovascular diseases", "Cerebrovascular Disease", diagnosis
  ))

```

 - Remove errant "p" from healthboard areas
```{r}
hospitalstays_by_healthboard <- hospitalstays_by_healthboard %>% 
  mutate(healthboard_area_named = str_remove_all(string = healthboard_area_named, pattern = "^p"))
```

----
Joins
----

Health Board Codes and Hospital Stays
```{r}
hospitalstays_by_healthboard <- hospitalstays_by_healthboard %>% 
  left_join(healthboard_codes, 
            by = c("healthboard_area_named" = "hb_name"))
```

Discharges and Mortality
```{r}
strokes_byhb <- discharges_by_healthboard %>% 
  full_join(mortality_by_healthboard, 
            by = c("approx_year" = "year", 
                   "sex" = "sex",
                   "healthboard_area" = "healthboard_area",
                   "age_group" = "age_group",
                   "diagnosis" = "diagnosis"
                   ),
            suffix = c("_discharge", "_mortality")
  )
```

Discharges and Mortality to Hospital stays
```{r}
strokes_byhb <- strokes_byhb %>% 
  full_join(hospitalstays_by_healthboard,
            by = c("financial_year", "age_group", "sex", "healthboard_area", "diagnosis")) %>% 
  rename("hospitalstays" = "stays", "crude_rate_stays" = "rate")
```

----
Write Clean Data
----
```{r}
write_csv(strokes_byhb, "../../data/clean_data/strokes_byhb.csv")
```

